<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Reset body and html */
       body, html {
           margin: 0;
           padding: 0;
           min-height: 100vh;
           display: flex;
           flex-direction: column;
       font-family: Arial, sans-serif;
       }

       /* Navbar styles */
       .navbar {
           display: flex;
           justify-content: space-between;
           align-items: center;
           background-color: #4A148C;
           padding: 0 20px;
           height: 70px; /* Consistent height */
           color: #fff;
           box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
           font-size: 1rem; /* Consistent text size */
       }

       .navbar .logo {
           font-size: 1.5rem;
           font-weight: bold;
           color: #f9a826;
           text-transform: uppercase;
       }

       .navbar ul {
           list-style: none;
           display: flex;
           gap: 20px;
           margin: 0;
       }

       .navbar ul li {
           display: inline;
       }

       .navbar ul li a {
           text-decoration: none;
           color: #fff;
           font-size: 1rem;
           transition: color 0.3s ease, background-color 0.3s ease;
           padding: 10px 15px;
           border-radius: 5px;
       }

       .navbar ul li a:hover {
           background-color: #6A1B9A;
           color: #f9a826;
       }

       /* Main content styles */
       #main-section {
           flex: 1; /* Ensures it grows to fill space between header and footer */
       }

       /* Footer styles */
       footer {
           text-align: center;
           padding: 15px 0;
           background-color: #4A148C;
           color: #fff;
           flex-shrink: 0;
       }

       footer p {
           margin: 0;
           font-size: 0.9rem;
       }
       .container {
           background: #fff;
           border-radius: 10px;
           padding: 20px;
           box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
           margin-bottom: 50px;
       }

       h1,
       h4 {
           color: #343a40;
           font-weight: bold;
       }

       .profile-section img {
           width: 150px;
           height: 150px;
           border-radius: 50%;
           box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
           object-fit: cover;
       }
       .profile-button {
           background-color: #4A148C;
           color: white;
           border: none;
           padding: 8px 16px;
           cursor: pointer;
           margin-top: 15px;
       }

       .profile-button:hover {
           background-color: #6A1B9A; color: #f9a826;
       }

       .form-input {
           width: 100%;
           padding: 10px;
           margin-bottom: 10px;
           border: 1px solid #ccc;
           border-radius: 5px;
       }

       .form-label {
           font-weight: bold;
       }

       .edit-form-container {
           display: none;
           margin-top: 20px;
       }
       .cancel-button {
           background-color: #6c757d;
           color: white;
           margin-left: 10px;
       }

       .cancel-button:hover {
           background-color: #5a6268;
       }

       .section-title {
           font-size: 2.8rem;
           color: #444;
           text-align: center;
           padding: 20px 0;
           /* Reduced padding */
           text-transform: uppercase;
           letter-spacing: 1.5px;
           margin-top: 30px;
           /* Reduced margin-bottom */
       }
    </style>
</head>

<body>

<!-- Navbar -->
<div class="navbar">
    <div class="logo">Coach</div>
    <ul>
        <li><a href="CoachHome.html">Home</a></li>
        <li><a href="CoachEvent.html">Events</a></li>
        <li><a href="AthletesForCoach.html">Athletes</a></li>
        <li><a href="CoachResult.html">Results</a></li>
        <li><a href="CoachNews.html">News</a></li>
        <li><a href="CoachProfile.html">Profile</a></li>
        <li><a href="" onclick="logout()">Logout</a></li>
    </ul>
</div>
<h1 class="section-title">Your Profile</h1>
<div class="container mt-4" id="main-section">

    <!-- Profile Section -->
    <div class="profile-section d-flex align-items-center mt-4">
        <img alt="Coach Picture" id="profile-image" src="images/user.png">
        <div class="ms-4">
            <h3 id="profile-name"></h3>
            <p>
                <strong>Email:</strong> <span id="email"></span><br>
                <strong>Date of Birth:</strong> <span id="dob"></span><br>
                <strong>Gender:</strong> <span id="gender"></span><br>
                <strong>Category:</strong> <span id="category"></span><br>
            </p>
            <button class="btn profile-button" onclick="editProfile()">Edit Profile</button>
        </div>
    </div>

    <!-- Edit Form Section -->
    <div class="edit-form-container">
        <h4>Edit Profile</h4>
        <form id="edit-form">
            <div class="form-group">
                <label class="form-label" for="edit-image">Profile Picture</label>
                <input accept="image/*" class="form-input" id="edit-image" type="file">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-name">Name</label>
                <input class="form-input" id="edit-name" type="text" value="">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-dob">Date of Birth</label>
                <input class="form-input" id="edit-dob" type="date" value="">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-gender">Gender</label>
                <select class="form-input" id="edit-gender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-category">Category</label>
                <input class="form-input" id="edit-category" type="text" value="">
            </div>
            <button class="profile-button" onclick="saveProfile()" type="button">Save Changes</button>
            <button class="profile-button cancel-button" onclick="cancelEdit()" type="button">Cancel</button>
        </form>
    </div>
</div>

<!-- Footer -->
<footer>
    <p>&copy; 2025 Sports Management System. All rights reserved.</p>
</footer>
<script crossorigin="anonymous"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script defer src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="TokenCheck.js"> </script>
<script>
    // Fetch and populate coach profile
    async function fetchProfile() {
    const coachId = localStorage.getItem("roleId");
    const token = localStorage.getItem("token");
    const email = localStorage.getItem("email");

    try {
        const response = await fetch(`http://localhost:8080/api/coach/search?id=${coachId}`, {
            headers: {
                Authorization: `Bearer ${token}`,
            },
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch profile: ${response.statusText}`);
        }

        const data = await response.json();

        // Update profile fields if data is available
        document.getElementById("profile-image").src = `data:image/png;base64,${data.imageLink || ""}`;
        document.getElementById("profile-name").textContent = data.name || "N/A";
        document.getElementById("email").textContent = email || "N/A";
        document.getElementById("dob").textContent = data.birthDate || "N/A";
        document.getElementById("gender").textContent = data.gender || "N/A";
        document.getElementById("category").textContent = data.category || "N/A";

        // Pre-fill edit form fields
        document.getElementById("edit-name").value = data.name || "";
        const dobField = document.getElementById("edit-dob");
        if (data.birthDate && dobField) {
            const birthDateParts = data.birthDate.split("/"); // Ensure date format is correct
            if (birthDateParts.length === 3) {
                dobField.value = birthDateParts.reverse().join("-"); // Convert to "YYYY-MM-DD"
            } else {
                console.warn("Invalid birthDate format. Expected 'DD/MM/YYYY'.");
                dobField.value = ""; // Set to empty if format is invalid
            }
        } else if (dobField) {
            dobField.value = ""; // Handle missing or invalid birthDate
        }

        document.getElementById("edit-gender").value = data.gender || "";
        document.getElementById("edit-category").value = data.category || "";

    } catch (error) {
        console.error(error);
        alert("Error fetching profile.");
    }
}

    // Save updated profile
    async function saveProfile() {
    const email = localStorage.getItem("email");
    const token = localStorage.getItem("token");

    const updatedData = {
        name: document.getElementById("edit-name").value,
        birthDate: document.getElementById("edit-dob").value.split("-").reverse().join("/"),
        gender: document.getElementById("edit-gender").value,
        category: document.getElementById("edit-category").value,
    };

    const formData = new FormData();
    formData.append("email", email);
    formData.append("CoachDTO", JSON.stringify(updatedData));
    const imageInput = document.getElementById("edit-image");
    if (imageInput.files.length > 0) {
        formData.append("imageLink", imageInput.files[0]);
    }

    try {
        const response = await fetch("http://localhost:8080/api/coach/profile", {
            method: "PUT",
            headers: {
                Authorization: `Bearer ${token}`, // Ensure token is valid
            },
            body: formData,
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`Backend error: ${response.status} - ${errorText}`);
            throw new Error(errorText || "Unknown error occurred");
        }

        alert("Profile updated successfully.");
        fetchProfile(); // Refresh profile data
        editProfile(); // Hide edit form
    } catch (error) {
        console.error("Error updating profile:", error);
        alert("Error updating profile. Please check your network or server.");
    }
}



    // Cancel editing
    function cancelEdit() {
        document.getElementById("edit-form").reset();
        fetchProfile();
        editProfile();
    }

    // Toggle edit form visibility
    function editProfile() {
        const editForm = document.querySelector(".edit-form-container");
        editForm.style.display = editForm.style.display === "none" || editForm.style.display === "" ? "block" : "none";
    }

    // Initialize profile fetch on page load
    window.onload = fetchProfile;
</script>

</body>
</html>
