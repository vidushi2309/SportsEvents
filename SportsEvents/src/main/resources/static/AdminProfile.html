<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Reset body and html */
         body, html {
             margin: 0;
             padding: 0;
             min-height: 100vh;
             display: flex;
             flex-direction: column;
         font-family: Arial, sans-serif;
         }

         /* Navbar styles */
         .navbar {
             display: flex;
             justify-content: space-between;
             align-items: center;
             background-color: #4A148C;
             padding: 0 20px;
             height: 70px; /* Consistent height */
             color: #fff;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
             font-size: 1rem; /* Consistent text size */
         }

         .navbar .logo {
             font-size: 1.5rem;
             font-weight: bold;
             color: #f9a826;
             text-transform: uppercase;
         }

         .navbar ul {
             list-style: none;
             display: flex;
             gap: 20px;
             margin: 0;
         }

         .navbar ul li {
             display: inline;
         }

         .navbar ul li a {
             text-decoration: none;
             color: #fff;
             font-size: 1rem;
             transition: color 0.3s ease, background-color 0.3s ease;
             padding: 10px 15px;
             border-radius: 5px;
         }

         .navbar ul li a:hover {
             background-color: #6A1B9A;
             color: #f9a826;
         }
        /* Footer styles */
         footer {
             text-align: center;
             padding: 15px 0;
             background-color: #4A148C;
             color: #fff;
             flex-shrink: 0;
         }

         footer p {
             margin: 0;
             font-size: 0.9rem;
         }


        /* Container for main content */
        .container {
            flex: 1;
            /* This ensures the container takes up available space */
            margin-bottom: 100px;
            padding: 20px;
        }

        /* Profile Section Styles */
        .container {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1, h4 {
            color: #343a40;
            font-weight: bold;
        }

        .profile-section img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .profile-info {
            margin-top: 20px;
        }

        .profile-info p {
            font-size: 1.1rem;
        }

        .profile-button {
             background-color: #4A148C;
             color: white;
             border: none;
             padding: 8px 16px;
             cursor: pointer;
             margin-top: 15px;
         }

         .profile-button:hover {
             background-color: #6A1B9A;
             color: #f9a826;
         }

          .form-input {
             width: 100%;
             padding: 10px;
             margin-bottom: 10px;
             border: 1px solid #ccc;
             border-radius: 5px;
         }

         .form-label {
             font-weight: bold;
         }

         .edit-form-container {
             display: none;
             margin-top: 20px;
         }

        .edit-form {
            display: none;
        }

        .form-group img {
            max-width: 150px;
            margin-top: 10px;
            border-radius: 50%;
            display: block;
        }

         .section-title {
             font-size: 2.8rem;
             color: #444;
             text-align: center;
             padding: 20px 0;
             /* Reduced padding */
             text-transform: uppercase;
             letter-spacing: 1.5px;
             margin-bottom: 20px;
             margin-top: 70px;
             /* Reduced margin-bottom */
         }

            #preview-img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 50%;
         }
    </style>
</head>

<body>

<!-- Admin Navigation Bar -->
<div class="navbar">
    <div class="logo">Admin</div>

    <ul>
        <li><a href="AdminHome.html">Home</a></li>
        <li><a href="AdminEvent.html">Events</a></li>
        <li><a href="CoachesForAdmin.html">Coaches</a></li>
        <li><a href="AthletesForAdmin.html">Athletes</a></li>
        <li><a href="AdminResult.html">Results</a></li>
        <li><a href="AdminNews.html">News</a></li>
        <li><a href="AdminProfile.html">Profile</a></li>
        <li><a href="#" id="logout-button">Logout</a></li>
    </ul>

</div>
<h1 class="section-title">Your Profile</h1>
<div class="container mt-4">
    <!-- loader spinner before showing profile -->
    <div id="loader" style="display: none;">Loading...</div>
    <div id="profile-container" style="display: none;">
        <!-- Profile Section -->
        <div class="profile-section d-flex align-items-center">
            <img alt="Admin Picture" id="profile-img" src="images/user.png">
            <div class="ms-4">
                <h3 id="admin-name"></h3>
                <div class="profile-info">
                </div>
                <button class="btn btn-warning" id="edit-profile-btn">Edit Profile</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Form (Hidden by default) -->
    <div class="edit-form mt-4">
        <h4>Edit Profile</h4>
        <form id="edit-profile-form">
            <div class="mb-3">
                <label class="form-label" for="edit-name">Name</label>
                <input class="form-control" id="edit-name" placeholder="Enter your name here" type="text">
            </div>
            <div class="mb-3">
                <label class="form-label" for="edit-experience">Experience</label>
                <input class="form-control" id="edit-experience" placeholder="eg:4 " type="number">
            </div>
            <div class="mb-3">
                <label class="form-label" for="edit-image">Profile Image</label>
                <input class="form-control" id="edit-image" type="file">
                <img alt="Image Preview" class="mt-2" id="preview-img" src="images/user.png">
            </div>
            <button class="btn btn-success" type="submit">Save Changes</button>
            <button class="btn btn-warning" onclick="cancelEdit()" type="button">Cancel</button>
        </form>
    </div>

</div>
<script crossorigin="anonymous"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script defer src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="TokenCheck.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem('token');
        const email = localStorage.getItem('email'); // Email saved during login
        const role = localStorage.getItem('role'); // Role saved during login

        // Show loader until profile data is fetched
        document.getElementById('loader').style.display = 'block';
        document.getElementById('profile-container').style.display = 'none';

        // Redirect to login if no token is present
        if (!token) {
            window.location.href = 'Login.html';
            return;
        }

        // Fetch admin profile data
        fetch(`http://localhost:8080/api/admins/profile?email=${email}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch profile');
            }
            return response.json();
        })
        .then(data => {
            // Hide loader and show profile container
            document.getElementById('loader').style.display = 'none';
            document.getElementById('profile-container').style.display = 'block';

            // Populate the profile with backend data
            document.getElementById('admin-name').textContent = data.name || 'N/A';

            // Check if the profile image is Base64 encoded and display it properly
            if (data.profileImage) {
                // Convert Base64 string to image
                document.getElementById('profile-img').src = `data:image/jpeg;base64,${data.profileImage}`;
            } else {
                document.getElementById('profile-img').src = 'images/user.png'; // Fallback image
            }

            document.querySelector('.profile-info').innerHTML = `
                <p><strong>Role:</strong> ${role || 'N/A'}</p>
                <p><strong>Experience:</strong> ${data.experience || 'N/A'} </p>
                <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
            `;

            // Show edit form when "Edit Profile" button is clicked
            document.getElementById('edit-profile-btn').addEventListener('click', () => {
                document.querySelector('.profile-info').style.display = 'none';
                document.getElementById('edit-profile-btn').style.display = 'none';
                document.querySelector('.edit-form').style.display = 'block';

                // Pre-fill form fields with current profile data
                document.getElementById('edit-name').value = data.name || '';
                document.getElementById('edit-experience').value = data.experience || '';
            });
        })
        .catch(error => {
            console.error('Error fetching profile:', error);
            alert('Failed to load profile. Redirecting to login.');
            localStorage.removeItem('token');
            window.location.href = 'Login.html';
        });

        // Attach logout functionality to the logout button
        const logoutButton = document.querySelector('#logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('role');
                window.location.href = 'Login.html';
            });
        }

        // Handle image preview when user selects an image
        document.getElementById('edit-image').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('preview-img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Save changes to the backend
        document.getElementById('edit-profile-form').addEventListener('submit', (event) => {
            event.preventDefault();

            const formData = new FormData();
            formData.append('email', email);
            formData.append(
                'adminDTO',
                JSON.stringify({
                    name: document.getElementById('edit-name').value,
                    experience: document.getElementById('edit-experience').value,
                })
            );

            const profileImage = document.getElementById('edit-image').files[0];
            if (profileImage) {
                formData.append('profileImage', profileImage);
            }

            fetch('http://localhost:8080/api/admins/profile', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update profile');
                }
                return response.text(); // Expecting a success message
            })
            .then(message => {
                alert(message);
                // Reload the profile information after update
                window.location.reload();
            })
            .catch(error => {
                console.error('Error updating profile:', error);
                alert('Failed to save changes.');
            });
        });

        // Function to cancel the edit and return to profile view
        window.cancelEdit = function() {
            document.querySelector('.edit-form').style.display = 'none';
            document.querySelector('.profile-info').style.display = 'block';
            document.getElementById('edit-profile-btn').style.display = 'inline-block';
        };
    });
</script>
<footer>
    <p>&copy; 2025 Sports Management System. All rights reserved.</p>
</footer>
</body>

</html>
