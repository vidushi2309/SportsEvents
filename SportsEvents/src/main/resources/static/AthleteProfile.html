<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Reset body and html */
       body, html {
           margin: 0;
           padding: 0;
           min-height: 100vh;
           display: flex;
           flex-direction: column;
       font-family: Arial, sans-serif;
       }

       /* Navbar styles */
       .navbar {
           display: flex;
           justify-content: space-between;
           align-items: center;
           background-color: #4A148C;
           padding: 0 20px;
           height: 70px; /* Consistent height */
           color: #fff;
           box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
           font-size: 1rem; /* Consistent text size */
       }

       .navbar .logo {
           font-size: 1.5rem;
           font-weight: bold;
           color: #f9a826;
           text-transform: uppercase;
       }

       .navbar ul {
           list-style: none;
           display: flex;
           gap: 20px;
           margin:0;
       }

       .navbar ul li {
           display: inline;
       }

       .navbar ul li a {
           text-decoration: none;
           color: #fff;
           font-size: 1rem;
           transition: color 0.3s ease, background-color 0.3s ease;
           padding: 10px 15px;
           border-radius: 5px;
       }

       .navbar ul li a:hover {
           background-color: #6A1B9A;
           color: #f9a826;
       }

       /* Main content styles */
       #main-section {
           flex: 1; /* Ensures it grows to fill space between header and footer */
       }

       /* Footer styles */
       footer {
           text-align: center;
           padding: 15px 0;
           background-color: #4A148C;
           color: #fff;
           flex-shrink: 0;
       }

       footer p {
           margin: 0;
           font-size: 0.9rem;
       }
       .container {
           background: #fff;
           border-radius: 10px;
           padding: 20px;
           box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
           margin-bottom: 50px;
       }

       h1,
       h4 {
           color: #343a40;
           font-weight: bold;
       }

       .profile-section img {
           width: 150px;
           height: 150px;
           border-radius: 50%;
           box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
           object-fit: cover;
       }
       .profile-button {
           background-color: #f9a826;
           color: white;
           border: none;
           padding: 8px 16px;
           cursor: pointer;
           margin-top: 15px;
       }

       .profile-button:hover {
           background-color: #6A1B9A;
           color: #f9a826;
       }

       .form-input {
           width: 100%;
           padding: 10px;
           margin-bottom: 10px;
           border: 1px solid #ccc;
           border-radius: 5px;
       }

       .form-label {
           font-weight: bold;
       }

       .edit-form-container {
           display: none;
           margin-top: 20px;
       }
       .cancel-button {
           background-color: #6c757d;
           color: white;
           margin-left: 10px;
       }

       .cancel-button:hover {
           background-color: #5a6268;
       }

       .section-title {
           font-size: 2.8rem;
           color: #444;
           text-align: center;
           padding: 20px 0;
           /* Reduced padding */
           text-transform: uppercase;
           letter-spacing: 1.5px;
           margin-top: 30px;
           /* Reduced margin-bottom */
       }
       .button { padding: 10px 20px; font-size: 16px; background-color: #4A148C; color: white; border: none; cursor: pointer; border-radius: 5px; margin-left: 1150px; } .button:hover { background-color: #6A1B9A; color: #f9a826;}
    </style>
</head>

<body>

<!-- Navbar -->
<div class="navbar">
    <div class="logo">Athlete</div>
    <ul>
        <li><a href="AthleteHome.html">Home</a></li>
        <li><a href="AthleteEvent.html">Events</a></li>
        <li><a href="CoachesForAthlete.html">Coaches</a></li>
        <li><a href="AthleteResult.html">Results</a></li>
        <li><a href="AthleteNews.html">News</a></li>
        <li><a href="AthleteProfile.html">Profile</a></li>
        <li><a href="#" id="logout-button">Logout</a></li>
    </ul>
</div>
<h1 class="section-title">Your Profile</h1>
<div class="container mt-4" id="main-section">

    <a href="AthleteDashboard.html">
        <button class="button">Dashboard</button>
    </a>

    <!-- Profile Section -->
    <div class="profile-section d-flex align-items-center mt-4">
        <img alt="Athlete Picture" id="profile-image" src="images/user.png">
        <div class="ms-4">
            <h3 id="profile-name"></h3>
            <p>
                <strong>Email:</strong> <span id="email"></span><br>
                <strong>Date of Birth:</strong> <span id="dob"></span><br>
                <strong>Gender:</strong> <span id="gender"></span><br>
                <strong>Height (cm):</strong> <span id="height"></span><br>
                <strong>Weight (kg):</strong> <span id="weight"></span><br>
                <strong>Category:</strong> <span id="category"></span><br>
                <strong>Coach:</strong> <span id="coach"></span>
            </p>
            <button class="btn btn-success" onclick="editProfile()">Edit Profile</button>
        </div>
    </div>

    <!-- Edit Form Section -->
    <div class="edit-form-container">
        <h4>Edit Profile</h4>
        <form id="edit-form">
            <div class="form-group">
                <label class="form-label" for="edit-image">Profile Picture</label>
                <input accept="image/*" class="form-input" id="edit-image" type="file">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-name">Name</label>
                <input class="form-input" id="edit-name" type="text" value="">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-dob">Date of Birth</label>
                <input class="form-input" id="edit-dob" type="date" value="">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-gender">Gender</label>
                <select class="form-input" id="edit-gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-height">Height (cm)</label>
                <input class="form-input" id="edit-height" type="number" value="">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-weight">Weight (kg)</label>
                <input class="form-input" id="edit-weight" type="number" value="">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-category">Category</label>
                <input class="form-input" id="edit-category" type="text" value="">
            </div>
            <button class="profile-button" onclick="saveProfile()" type="button">Save Changes</button>
            <button class="profile-button cancel-button" onclick="cancelEdit()" type="button">Cancel</button>
        </form>
    </div>
</div>

<!-- Footer -->
<footer>
    <p>&copy; 2025 Sports Management System. All rights reserved.</p>
</footer>
<script crossorigin="anonymous"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script defer src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="TokenCheck.js"></script>
<script>

    // Toggle visibility of the edit profile section
    function editProfile() {
      const editForm = document.querySelector(".edit-form-container");
      editForm.style.display = editForm.style.display === "none" || editForm.style.display === "" ? "block" : "none";
    }

    // Fetch athlete profile and populate fields
async function fetchProfile() {
  const email = localStorage.getItem("email");
  const token = localStorage.getItem("token");
  const athleteId = localStorage.getItem("roleId"); // Assuming athleteId is stored in localStorage

  if (!email || !token || !athleteId) {
    alert("Session expired. Please log in again.");
    window.location.href = 'Login.html';
    return;
  }

  try {
    // Fetch and populate profile
    await fetchAndPopulateProfile(email, token);

    // Fetch and display coach information
    await fetchAndDisplayCoachInfo(athleteId, token);
  } catch (error) {
    console.error(error);
    alert("Error fetching profile. Please try again.");
  }
}

// Fetch and populate athlete's profile
async function fetchAndPopulateProfile(email, token) {
  const response = await fetch(`http://localhost:8080/api/athlete/profile?email=${email}`, {
    method: "GET",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
    },
  });

  if (!response.ok) {
    throw new Error(`Failed to fetch profile: ${response.statusText}`);
  }

  const data = await response.json();

  // Populate profile fields
  document.getElementById("profile-image").src = `data:image/png;base64,${data.imageLink}`;
  document.getElementById("profile-name").textContent = data.name;
  document.getElementById("email").textContent = email;
  document.getElementById("dob").textContent = data.birthDate || "N/A";
  document.getElementById("gender").textContent = data.gender || "N/A";
  document.getElementById("height").textContent = `${data.height || "N/A"}`;
  document.getElementById("weight").textContent = `${data.weight || "N/A"}`;
  document.getElementById("category").textContent = data.category || "N/A";

  // Pre-fill edit form fields
  document.getElementById("edit-name").value = data.name;
  document.getElementById("edit-dob").value = data.birthDate;
  document.getElementById("edit-gender").value = data.gender;
  document.getElementById("edit-height").value = data.height;
  document.getElementById("edit-weight").value = data.weight;
  document.getElementById("edit-category").value = data.category;
}

// Fetch and display coach information
async function fetchAndDisplayCoachInfo(athleteId, token) {
  const assistanceResponse = await fetch(`http://localhost:8080/api/assistance/search?athleteId=${athleteId}`, {
    method: "GET",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
    },
  });

  if (!assistanceResponse.ok) {
    throw new Error(`Failed to fetch assistance status: ${assistanceResponse.statusText}`);
  }

  const assistanceData = await assistanceResponse.json();
  let coachNames = [];

  if (Array.isArray(assistanceData)) {
    for (const assistance of assistanceData) {
      if (assistance.status === "ACCEPTED" && assistance.coachId) {
        const coachName = await fetchCoachName(assistance.coachId, token);
        if (coachName) {
          coachNames.push(coachName);
        }
      }
    }
  }

  // Update the coach field in the profile
  document.getElementById("coach").textContent = coachNames.length > 0
    ? coachNames.join(", ")
    : "N/A";
}

// Fetch coach name by coach ID
async function fetchCoachName(coachId, token) {
  const coachResponse = await fetch(`http://localhost:8080/api/coach/search?id=${coachId}`, {
    method: "GET",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
    },
  });

  if (coachResponse.ok) {
    const coachData = await coachResponse.json();
    return coachData.name || null;
  }
  return null;
}

// Save profile updates

    async function saveProfile() {
      const email = localStorage.getItem("email");
      const token = localStorage.getItem("token");

      if (!email || !token) {
        alert("Session expired. Please log in again.");
        window.location.href = 'Login.html';
        return;
      }

      const updatedData = {
        name: document.getElementById("edit-name").value,
        birthDate: document.getElementById("edit-dob").value,
        gender: document.getElementById("edit-gender").value,
        height: document.getElementById("edit-height").value,
        weight: document.getElementById("edit-weight").value,
        category: document.getElementById("edit-category").value,
      };

      const formData = new FormData();
      formData.append("email", email);
      formData.append("AthleteDTO", JSON.stringify(updatedData));

      const imageInput = document.getElementById("edit-image");
      if (imageInput.files.length > 0) {
        formData.append("imageLink", imageInput.files[0]);
      }

      try {
        const response = await fetch("http://localhost:8080/api/athlete/profile", {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        });

        if (!response.ok) {
          throw new Error(`Failed to update profile: ${response.statusText}`);
        }

        alert("Profile updated successfully.");
        fetchProfile(); // Refresh profile data
        editProfile(); // Hide edit form
      } catch (error) {
        console.error(error);
        alert("Error saving profile. Please try again.");
      }
    }

    // Cancel editing and reset form
    function cancelEdit() {
      document.getElementById("edit-form").reset();
      fetchProfile(); // Refresh profile data
      editProfile(); // Hide edit form
    }

    // Ensure edit form is hidden initially
    document.querySelector(".edit-form-container").style.display = "none";

    // Initial call to fetch profile when the page loads
    window.onload = fetchProfile;

    // Add event listener for logout button
    document.addEventListener("DOMContentLoaded", () => {
      const logoutButton = document.getElementById("logout-button");
      if (logoutButton) {
        logoutButton.addEventListener("click", logout);
      }
    });
</script>
</body>

</html>